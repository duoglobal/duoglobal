<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Browse Gentlemen | DuoGlobal</title>
    <meta name="theme-color" content="#0052CC">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/images/icon-192.png">
    <link rel="apple-touch-icon" href="assets/images/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root {
            --primary-blue: #0052CC;
            --primary-dark: #003E99;
            --primary-gradient: linear-gradient(135deg, #0052CC 0%, #003380 100%);
            --accent-pink: #FF6B6B;
            --text-dark: #1e293b;
            --text-grey: #64748b;
            --bg-light: #f8fafc;
            
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.6);
            --shadow-card: 0 10px 30px rgba(0,0,0,0.08);
            --border-radius: 20px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {margin:0;padding:0;box-sizing:border-box;}

        body {
            font-family: 'Inter', sans-serif;
            background: url('assets/images/background.png') repeat, var(--bg-light);
            background-size: 400px;
            color: var(--text-dark);
            min-height: 100vh;
            padding-bottom: 100px; /* Space for bottom nav */
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            opacity: 0;
            animation: fadeInPage 0.6s ease-out forwards;
        }

        @keyframes fadeInPage { to { opacity: 1; } }

        /* PRELOADER */
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .loader {
            width: 40px; height: 40px; border: 4px solid #e2e8f0;
            border-top-color: var(--primary-blue); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* ---- TOP HEADER ---- */
        .dashboard-header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.5);
            padding: 15px 20px;
            display: flex; flex-direction: column; gap: 15px;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            animation: slideDown 0.6s ease-out;
        }
        /* Header hides on scroll down too */
        .dashboard-header.hidden { transform: translateY(-100%); }

        .header-top { display: flex; justify-content: space-between; align-items: center; }
        
        .welcome-msg { font-size: 0.9rem; color: var(--text-grey); font-weight: 500; }
        .welcome-msg span { color: var(--primary-blue); font-weight: 700; }
        
        .user-avatar {
            width: 42px; height: 42px; border-radius: 50%;
            object-fit: cover; border: 2px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer; transition: var(--transition);
        }
        .user-avatar:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,82,204,0.2); }

        /* Search Bar */
        .search-bar { position: relative; width: 100%; }
        .search-input {
            width: 100%; padding: 14px 15px 14px 45px;
            border-radius: 50px; border: 1px solid rgba(0,0,0,0.05);
            background: rgba(255,255,255,0.8); font-size: 0.95rem; transition: var(--transition);
            font-family: 'Inter', sans-serif;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }
        .search-input:focus { 
            outline: none; border-color: var(--primary-blue); 
            background: #fff; box-shadow: 0 4px 15px rgba(0,82,204,0.15); 
            transform: scale(1.01);
        }
        .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

        /* ---- FILTER CHIPS ---- */
        .filter-scroller {
            display: flex; gap: 10px; overflow-x: auto; padding: 10px 20px 20px 20px;
            scrollbar-width: none; /* Hide scrollbar Firefox */
            margin-top: -5px;
            animation: slideInRight 0.6s ease-out 0.2s backwards;
        }
        .filter-scroller::-webkit-scrollbar { display: none; } /* Hide Chrome */

        .filter-chip {
            padding: 10px 20px; background: rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.5);
            border-radius: 30px; font-size: 0.85rem; color: var(--text-grey);
            white-space: nowrap; cursor: pointer; transition: var(--transition); font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            backdrop-filter: blur(5px);
        }
        .filter-chip:hover { transform: translateY(-2px); background: #fff; }
        .filter-chip.active { 
            background: var(--primary-gradient); color: white; 
            border-color: transparent; box-shadow: 0 6px 15px rgba(0,82,204,0.3);
            transform: translateY(-2px);
        }

        /* ---- PROFILE GRID ---- */
        .main-content {
            padding: 10px 20px;
            max-width: 1200px; margin: 0 auto;
        }

        .section-title { 
            font-family: 'Playfair Display', serif; font-size: 1.6rem; 
            margin-bottom: 25px; font-weight: 700; color: var(--primary-dark);
            animation: fadeIn 0.8s ease-out 0.3s backwards;
        }

        .grid-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        /* Profile Card */
        .profile-card {
            background: #fff; border-radius: var(--border-radius);
            overflow: hidden; box-shadow: var(--shadow-card);
            position: relative; transition: var(--transition);
            cursor: pointer; border: 1px solid rgba(255,255,255,0.5);
            transform: translateZ(0); /* Hardware accel */
            opacity: 0; /* For Staggered Animation */
        }
        
        .profile-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 40px rgba(0,82,204,0.15); }

        .card-img-wrap { height: 360px; position: relative; overflow: hidden; background: #f1f5f9; }
        .card-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.6s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .profile-card:hover .card-img { transform: scale(1.08); }

        .card-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 60%, transparent 100%);
            padding: 90px 20px 20px 20px;
            color: white;
            transition: var(--transition);
        }

        .card-name { font-size: 1.4rem; font-weight: 700; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; font-family: 'Playfair Display', serif; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .card-meta { font-size: 0.95rem; opacity: 0.9; display: flex; align-items: center; gap: 8px; font-weight: 500; }
        
        .flag { font-size: 1.4rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }

        /* ---- SKELETON LOADING ---- */
        .skeleton { animation: pulse 1.5s infinite; background: #e2e8f0; opacity: 1 !important; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* ---- BOTTOM NAV (Auto-Hide) ---- */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 500px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; justify-content: space-between;
            padding: 12px 25px; border-radius: 30px; z-index: 9999;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.5);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .bottom-nav.hidden { transform: translateX(-50%) translateY(200%); }

        .nav-item { 
            text-decoration: none; color: #94a3b8; display: flex; flex-direction: column; 
            align-items: center; gap: 5px; font-size: 0.7rem; font-weight: 600; transition: 0.3s;
            flex: 1;
        }
        .nav-item i { font-size: 1.3rem; margin-bottom: 2px; transition: 0.3s; }
        .nav-item:hover { color: var(--primary-blue); }
        .nav-item.active { color: var(--primary-blue); }
        .nav-item.active i { transform: translateY(-3px); filter: drop-shadow(0 4px 6px rgba(0,82,204,0.2)); }

        /* Badge for notifications */
        .nav-item.has-badge { position: relative; }
        .nav-item.has-badge::after {
            content: ''; position: absolute; top: 0; right: 28%;
            width: 8px; height: 8px; background: var(--accent-pink);
            border-radius: 50%; border: 2px solid #fff;
        }

        /* Animations */
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- Preloader -->
    <div id="preloader">
        <div class="loader"></div>
    </div>

    <!-- Header -->
    <header class="dashboard-header" id="dashboardHeader">
        <div class="header-top">
            <a href="index.html" style="text-decoration: none; display: flex; align-items: center; gap: 8px;">
                <img src="assets/images/logo.png" alt="" height="32" onerror="this.style.display='none'">
                <span style="font-family: 'Playfair Display', serif; font-weight: 700; color: var(--primary-dark); font-size: 1.2rem;">DuoGlobal</span>
            </a>
            <div style="display: flex; align-items: center; gap: 12px;">
                <p class="welcome-msg">Hi, <span id="userName">User</span></p>
                <a href="user-profile.html">
                    <img id="userAvatar" src="assets/images/placeholder-woman.png" class="user-avatar" alt="User">
                </a>
            </div>
        </div>
        
        <div class="search-bar">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Search by Country, Job or Age...">
        </div>
    </header>

    <!-- Filter Chips -->
    <div class="filter-scroller">
        <div class="filter-chip active" data-filter="all">All</div>
        <div class="filter-chip" data-filter="USA">USA</div>
        <div class="filter-chip" data-filter="UK">UK</div>
        <div class="filter-chip" data-filter="Germany">Germany</div>
        <div class="filter-chip" data-filter="Canada">Canada</div>
        <div class="filter-chip" data-filter="Europe">Europe</div>
        <div class="filter-chip" data-filter="Australia">Australia</div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <h2 class="section-title">Verified Gentlemen</h2>
        
        <!-- Grid Container -->
        <div class="grid-container" id="profilesGrid">
            <!-- Skeleton Loaders (Visible initially) -->
            <div class="profile-card skeleton" style="height: 360px;"></div>
            <div class="profile-card skeleton" style="height: 360px;"></div>
            <div class="profile-card skeleton" style="height: 360px;"></div>
            <div class="profile-card skeleton" style="height: 360px;"></div>
        </div>

        <div id="noResults" style="text-align: center; padding: 60px 20px; display: none; color: var(--text-grey);">
            <div style="width: 80px; height: 80px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: var(--shadow-card);">
                <i class="fas fa-search" style="font-size: 2rem; color: #cbd5e1;"></i>
            </div>
            <h3 style="color: var(--text-dark); margin-bottom: 5px;">No profiles found</h3>
            <p>Try adjusting your search or filters.</p>
        </div>
    </main>

    <!-- Bottom Navigation (Auto-Hide) -->
    <nav class="bottom-nav" id="bottomNav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i> <span>Home</span>
        </a>
        <a href="dashboard.html" class="nav-item active">
            <i class="fas fa-search"></i> <span>Browse</span>
        </a>
        <a href="my-connections.html" class="nav-item has-badge">
            <i class="fas fa-heart"></i> <span>Matches</span>
        </a>
        <a href="chat.html" class="nav-item">
            <i class="fas fa-comment-dots"></i> <span>Chat</span>
        </a>
        <a href="user-profile.html" class="nav-item">
            <i class="fas fa-user-circle"></i> <span>Profile</span>
        </a>
    </nav>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { auth, db } from './config.js'; 
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';
        import { collection, query, orderBy, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js';

        const profilesGrid = document.getElementById('profilesGrid');
        const userNameSpan = document.getElementById('userName');
        const userAvatarImg = document.getElementById('userAvatar');
        const searchInput = document.getElementById('searchInput');
        const filterChips = document.querySelectorAll('.filter-chip');
        const noResults = document.getElementById('noResults');
        const preloader = document.getElementById('preloader');

        let allProfiles = []; // Store fetched data locally for fast filtering

        // Remove Preloader
        window.addEventListener('load', () => {
            preloader.style.opacity = '0';
            setTimeout(() => preloader.style.display = 'none', 500);
        });

        // 1. Auth Check & User Data
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Get User Details from Firestore for Avatar/Name
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        userNameSpan.innerText = data.fullName.split(' ')[0]; // First name only
                        if (data.photoURL) userAvatarImg.src = data.photoURL;
                    }
                } catch(e) {
                    console.log("Error fetching user data", e);
                }
                loadProfiles();
            } else {
                window.location.href = 'login.html';
            }
        });

        // 2. Fetch Profiles from Firestore
        async function loadProfiles() {
            try {
                // Query: Get all profiles ordered by newest
                const q = query(collection(db, "men_profiles"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                allProfiles = [];
                querySnapshot.forEach((doc) => {
                    allProfiles.push({ id: doc.id, ...doc.data() });
                });

                renderProfiles(allProfiles);

            } catch (error) {
                console.error("Error fetching profiles:", error);
                profilesGrid.innerHTML = `<p style="text-align:center; color:red; grid-column:1/-1;">Error loading profiles.</p>`;
            }
        }

        // 3. Render Logic
        function renderProfiles(profiles) {
            profilesGrid.innerHTML = ''; // Clear skeletons

            if (profiles.length === 0) {
                profilesGrid.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            profilesGrid.style.display = 'grid';
            noResults.style.display = 'none';

            profiles.forEach((profile, index) => {
                // Default fallback values
                const img = profile.photoURL || 'assets/images/placeholder-man.jpg';
                const flag = profile.flagEmoji || 'üåç';
                const country = profile.nationality || 'International';
                const age = profile.age || 'N/A';
                const job = profile.occupation || 'Professional';

                // Staggered Animation Delay
                const delay = index * 0.1; 

                const cardHTML = `
                <div class="profile-card" onclick="window.location.href='profile-view.html?id=${profile.id}'" style="animation: slideUp 0.6s ease-out forwards ${delay}s;">
                    <div class="card-img-wrap">
                        <img src="${img}" alt="${job}" class="card-img" loading="lazy">
                        <div class="card-overlay">
                            <h3 class="card-name">
                                ${job} <span class="flag">${flag}</span>
                            </h3>
                            <div class="card-meta">
                                <span>${age} Years Old</span> ‚Ä¢ <span>${country}</span>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                profilesGrid.insertAdjacentHTML('beforeend', cardHTML);
            });
        }

        // 4. Search Functionality
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allProfiles.filter(p => 
                (p.nationality && p.nationality.toLowerCase().includes(term)) ||
                (p.occupation && p.occupation.toLowerCase().includes(term)) ||
                (p.age && p.age.toString().includes(term))
            );
            renderProfiles(filtered);
        });

        // 5. Chip Filtering
        filterChips.forEach(chip => {
            chip.addEventListener('click', () => {
                // UI Toggle
                filterChips.forEach(c => c.classList.remove('active'));
                chip.classList.add('active');

                const filterVal = chip.getAttribute('data-filter');
                
                if (filterVal === 'all') {
                    renderProfiles(allProfiles);
                } else {
                    const filtered = allProfiles.filter(p => 
                        p.nationality && p.nationality.includes(filterVal)
                    );
                    renderProfiles(filtered);
                }
            });
        });
    </script>

    <!-- UI SCRIPTS (Nav Auto-Hide & PWA) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Auto-Hide Header & Bottom Nav Logic
            const bottomNav = document.getElementById('bottomNav');
            const header = document.getElementById('dashboardHeader');
            let lastScroll = 0;

            window.addEventListener('scroll', () => {
                const currentScroll = window.pageYOffset;
                
                if (currentScroll <= 0) {
                    bottomNav.classList.remove('hidden');
                    header.classList.remove('hidden');
                } else {
                    if (currentScroll > lastScroll && currentScroll > 50) {
                        // Scrolling DOWN -> Hide
                        bottomNav.classList.add('hidden');
                        header.classList.add('hidden');
                    } else {
                        // Scrolling UP -> Show
                        bottomNav.classList.remove('hidden');
                        header.classList.remove('hidden');
                    }
                }
                lastScroll = currentScroll;
            });

            // 2. Service Worker Registration (No Popup)
            if("serviceWorker" in navigator) {
                navigator.serviceWorker.register("./service-worker.js").catch(e => console.log("SW Error:", e));
            }
        });
    </script>
</body>
</html>
