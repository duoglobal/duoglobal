<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Profile | DuoGlobal</title>
    <meta name="theme-color" content="#0052CC">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/images/icon-192.png">
    <link rel="apple-touch-icon" href="assets/images/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root {
            --primary-blue: #0052CC;
            --primary-dark: #003E99;
            --primary-gradient: linear-gradient(135deg, #0052CC 0%, #003380 100%);
            --accent-pink: #FF6B6B;
            --text-dark: #1e293b;
            --text-grey: #64748b;
            --bg-light: #f8fafc;
            
            --glass-bg: rgba(255, 255, 255, 0.95);
            --shadow-card: 0 10px 30px rgba(0,0,0,0.06);
            --border-radius: 24px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --success-green: #22c55e;
        }

        * {margin:0;padding:0;box-sizing:border-box;}

        body {
            font-family: 'Inter', sans-serif;
            background: url('assets/images/background.png') repeat, var(--bg-light);
            background-size: 400px;
            color: var(--text-dark);
            min-height: 100vh;
            padding-bottom: 120px;
            -webkit-font-smoothing: antialiased;
            opacity: 0;
            animation: fadeInPage 0.6s ease-out forwards;
        }

        @keyframes fadeInPage { to { opacity: 1; } }

        /* ---- PROFILE HEADER (Gradient) ---- */
        .header-bg {
            height: 220px;
            background: var(--primary-gradient);
            position: relative;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
            animation: slideDown 0.8s ease-out;
            box-shadow: 0 10px 30px rgba(0,82,204,0.3);
        }

        .settings-btn {
            position: absolute; top: 20px; right: 20px;
            color: white; font-size: 1.4rem; cursor: pointer;
            background: rgba(255,255,255,0.15); width: 44px; height: 44px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px); transition: var(--transition);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .settings-btn:hover { background: rgba(255,255,255,0.3); transform: rotate(90deg); }

        /* ---- PROFILE CARD ---- */
        .profile-container {
            max-width: 600px; margin: -100px auto 0; padding: 0 20px;
            position: relative; z-index: 10;
        }

        .profile-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: var(--border-radius);
            padding: 40px 30px; 
            box-shadow: var(--shadow-card);
            text-align: center;
            animation: slideUp 0.8s ease-out 0.2s backwards;
            position: relative;
        }

        .avatar-wrapper {
            position: relative; width: 130px; height: 130px; margin: 0 auto 20px;
        }
        .profile-avatar {
            width: 100%; height: 100%; border-radius: 50%;
            object-fit: cover; border: 5px solid #fff;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            transition: var(--transition);
        }
        .edit-avatar-btn {
            position: absolute; bottom: 5px; right: 5px;
            background: var(--primary-blue); color: white;
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 0.95rem; border: 3px solid #fff;
            transition: var(--transition);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .edit-avatar-btn:hover { transform: scale(1.1); background: var(--primary-dark); }

        .user-name { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 700; margin-bottom: 8px; color: var(--text-dark); }
        .user-meta { font-size: 0.95rem; color: var(--text-grey); display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 500; }
        .user-meta i { color: var(--primary-blue); }

        .edit-toggle-btn {
            margin-top: 20px; padding: 10px 24px; border-radius: 30px;
            background: rgba(241, 245, 249, 0.8); color: var(--text-dark); font-size: 0.85rem; font-weight: 600;
            border: 1px solid rgba(0,0,0,0.05); cursor: pointer; transition: var(--transition);
            display: inline-flex; align-items: center; gap: 8px;
        }
        .edit-toggle-btn:hover { background: #e2e8f0; transform: translateY(-2px); }

        /* ---- FORM SECTIONS ---- */
        .form-section { margin-top: 30px; text-align: left; animation: fadeIn 0.5s ease-out; }
        
        .section-header {
            font-size: 0.8rem; font-weight: 700; text-transform: uppercase;
            color: var(--text-grey); letter-spacing: 1.2px; margin-bottom: 18px;
            border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;
        }

        .input-group { margin-bottom: 18px; }
        .label { font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; display: block; color: var(--text-grey); }
        
        .field-input, .field-textarea {
            width: 100%; padding: 14px; border: 1px solid #cbd5e1;
            border-radius: 12px; font-family: 'Inter', sans-serif;
            background: rgba(255,255,255,0.5); color: var(--text-dark);
            font-size: 0.95rem; transition: var(--transition);
        }
        .field-input:focus, .field-textarea:focus {
            background: #fff; border-color: var(--primary-blue); outline: none;
            box-shadow: 0 4px 12px rgba(0,82,204,0.08);
        }
        .field-input:disabled, .field-textarea:disabled {
            background: transparent; border-color: transparent; padding-left: 0; color: #1e293b; cursor: default;
        }
        
        .save-btn {
            width: 100%; padding: 16px; background: var(--success-green); color: white;
            border: none; border-radius: 14px; font-weight: 600; margin-top: 25px;
            display: none; cursor: pointer; transition: var(--transition);
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.3);
        }
        .save-btn:hover { background: #16a34a; transform: translateY(-2px); }

        /* ---- MENU ITEMS ---- */
        .menu-list { margin-top: 35px; }
        .menu-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 18px; background: rgba(255,255,255,0.8); border-radius: 16px;
            margin-bottom: 12px; text-decoration: none; color: var(--text-dark);
            box-shadow: var(--shadow-card); transition: var(--transition);
            border: 1px solid rgba(255,255,255,0.6);
            backdrop-filter: blur(10px);
            animation: slideUp 0.5s ease-out backwards;
        }
        
        .menu-item:nth-child(1) { animation-delay: 0.3s; }
        .menu-item:nth-child(2) { animation-delay: 0.4s; }
        .menu-item:nth-child(3) { animation-delay: 0.5s; }
        .menu-item:nth-child(4) { animation-delay: 0.6s; }

        .menu-item:hover { transform: translateY(-3px); background: #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .menu-left { display: flex; align-items: center; gap: 15px; font-weight: 600; font-size: 0.95rem; }
        .menu-icon { 
            width: 36px; height: 36px; background: #eff6ff; color: var(--primary-blue); 
            border-radius: 10px; display: flex; align-items: center; justify-content: center; 
            font-size: 1.1rem; transition: var(--transition);
        }
        .menu-item:hover .menu-icon { background: var(--primary-blue); color: white; }
        
        .btn-logout {
            margin-top: 25px; width: 100%; padding: 16px;
            background: #fef2f2; color: #ef4444; border: 1px solid #fee2e2; border-radius: 16px;
            font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: var(--transition);
            font-size: 0.95rem;
        }
        .btn-logout:hover { background: #fee2e2; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(239, 68, 68, 0.15); }

        /* ---- LOADING OVERLAY ---- */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 2000; display: flex; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .spinner { width: 45px; height: 45px; border: 4px solid #e2e8f0; border-top-color: var(--primary-blue); border-radius: 50%; animation: spin 0.8s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ---- BOTTOM NAV (Auto-Hide) ---- */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 500px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 25px; border-radius: 30px; z-index: 9999;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.5);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .bottom-nav.hidden { transform: translateX(-50%) translateY(200%); }
        
        .nav-item { 
            text-decoration: none; color: #94a3b8; display: flex; flex-direction: column; 
            align-items: center; gap: 5px; font-size: 0.7rem; font-weight: 600; transition: 0.3s;
            flex: 1; cursor: pointer;
        }
        .nav-item i { font-size: 1.3rem; transition: 0.3s; }
        .nav-item.active { color: var(--primary-blue); }
        .nav-item:hover { color: var(--primary-blue); }
        .nav-item:hover i { transform: translateY(-2px); }
        .nav-item.active i { transform: translateY(-2px); filter: drop-shadow(0 4px 6px rgba(0,82,204,0.2)); }

        /* Animations */
        @keyframes slideDown { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div class="loading-overlay" id="loadingScreen">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <div class="header-bg">
        <div class="settings-btn" onclick="alert('Settings feature coming soon!')">
            <i class="fas fa-cog"></i>
        </div>
    </div>

    <!-- Profile Card -->
    <div class="profile-container">
        <div class="profile-card">
            
            <div class="avatar-wrapper">
                <img id="uAvatar" src="assets/images/placeholder-woman.png" class="profile-avatar" alt="Profile">
                <label for="fileInput" class="edit-avatar-btn">
                    <i class="fas fa-camera"></i>
                </label>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>

            <h2 class="user-name" id="uName">Loading...</h2>
            <div class="user-meta">
                <i class="fas fa-map-marker-alt"></i>
                <span id="uLocation">...</span>
            </div>

            <button class="edit-toggle-btn" id="editBtn">
                <i class="fas fa-pen"></i> Edit Profile
            </button>

            <!-- Editable Fields -->
            <form id="profileForm">
                
                <div class="form-section">
                    <div class="section-header">Personal Info</div>
                    
                    <div class="input-group">
                        <label class="label">Full Name</label>
                        <input type="text" id="inpName" class="field-input" disabled>
                    </div>
                    
                    <div class="input-group">
                        <label class="label">Location</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="inpCity" class="field-input" placeholder="City" disabled>
                            <input type="text" id="inpCountry" class="field-input" placeholder="Country" disabled>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="label">Occupation</label>
                        <input type="text" id="inpJob" class="field-input" disabled>
                    </div>

                    <div class="input-group">
                        <label class="label">Phone (WhatsApp)</label>
                        <input type="tel" id="inpPhone" class="field-input" disabled>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-header">About Me</div>
                    <textarea id="inpBio" class="field-textarea" rows="4" disabled></textarea>
                </div>

                <button type="submit" class="save-btn" id="saveBtn">Save Changes</button>
            </form>
        </div>

        <!-- Menu Links -->
        <div class="menu-list">
            <a href="my-connections.html" class="menu-item">
                <div class="menu-left">
                    <div class="menu-icon"><i class="fas fa-heart"></i></div>
                    My Connections
                </div>
                <i class="fas fa-chevron-right" style="color: #cbd5e1;"></i>
            </a>
            
            <a href="safety.html" class="menu-item">
                <div class="menu-left">
                    <div class="menu-icon"><i class="fas fa-shield-alt"></i></div>
                    Safety & Privacy
                </div>
                <i class="fas fa-chevron-right" style="color: #cbd5e1;"></i>
            </a>

            <a href="contact.html" class="menu-item">
                <div class="menu-left">
                    <div class="menu-icon"><i class="fas fa-headset"></i></div>
                    Help & Support
                </div>
                <i class="fas fa-chevron-right" style="color: #cbd5e1;"></i>
            </a>

            <button class="btn-logout" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Sign Out
            </button>
        </div>
    </div>

    <!-- Bottom Navigation (Auto-Hide) -->
    <nav class="bottom-nav" id="bottomNav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i> <span>Home</span>
        </a>
        <a href="dashboard.html" class="nav-item">
            <i class="fas fa-search"></i> <span>Browse</span>
        </a>
        <a href="my-connections.html" class="nav-item">
            <i class="fas fa-heart"></i> <span>Matches</span>
        </a>
        <a href="chat.html" class="nav-item">
            <i class="fas fa-comment-dots"></i> <span>Chat</span>
        </a>
        <a href="user-profile.html" class="nav-item active">
            <i class="fas fa-user-circle"></i> <span>Profile</span>
        </a>
    </nav>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { auth, db, storage } from './config.js'; 
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';
        import { doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js';
        import { ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-storage.js';

        let currentUser = null;
        let isEditing = false;

        // Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const editBtn = document.getElementById('editBtn');
        const saveBtn = document.getElementById('saveBtn');
        const inputs = document.querySelectorAll('.field-input, .field-textarea');
        const fileInput = document.getElementById('fileInput');
        const uAvatar = document.getElementById('uAvatar');

        // Check Auth
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData(user.uid);
                // Fade out loading screen
                loadingScreen.style.opacity = '0';
                setTimeout(() => loadingScreen.style.display = 'none', 500);
            } else {
                window.location.href = 'login.html';
            }
        });

        // Load Data
        async function loadUserData(uid) {
            try {
                const docRef = doc(db, "users", uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Header
                    document.getElementById('uName').innerText = data.fullName || "User";
                    document.getElementById('uLocation').innerText = `${data.city || ''}, ${data.country || ''}`;
                    if(data.photoURL) uAvatar.src = data.photoURL;

                    // Inputs
                    document.getElementById('inpName').value = data.fullName || "";
                    document.getElementById('inpCity').value = data.city || "";
                    document.getElementById('inpCountry').value = data.country || "";
                    document.getElementById('inpJob').value = data.occupation || "";
                    document.getElementById('inpPhone').value = data.phone || "";
                    document.getElementById('inpBio').value = data.bio || "";

                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }

        // Toggle Edit Mode
        editBtn.addEventListener('click', (e) => {
            e.preventDefault();
            isEditing = !isEditing;
            
            inputs.forEach(input => input.disabled = !isEditing);
            
            if (isEditing) {
                editBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
                editBtn.style.background = '#fee2e2';
                editBtn.style.color = '#ef4444';
                saveBtn.style.display = "block";
                inputs[0].focus();
            } else {
                editBtn.innerHTML = '<i class="fas fa-pen"></i> Edit Profile';
                editBtn.style.background = 'rgba(241, 245, 249, 0.8)';
                editBtn.style.color = 'var(--text-dark)';
                saveBtn.style.display = "none";
                // Optionally reload data to reset changes
                loadUserData(currentUser.uid);
            }
        });

        // Save Changes
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            saveBtn.innerText = "Saving...";
            saveBtn.disabled = true;

            const updatedData = {
                fullName: document.getElementById('inpName').value,
                city: document.getElementById('inpCity').value,
                country: document.getElementById('inpCountry').value,
                occupation: document.getElementById('inpJob').value,
                phone: document.getElementById('inpPhone').value,
                bio: document.getElementById('inpBio').value
            };

            try {
                await updateDoc(doc(db, "users", currentUser.uid), updatedData);
                
                // Update UI Header
                document.getElementById('uName').innerText = updatedData.fullName;
                document.getElementById('uLocation').innerText = `${updatedData.city}, ${updatedData.country}`;
                
                // Reset Mode
                isEditing = false;
                inputs.forEach(input => input.disabled = true);
                editBtn.innerHTML = '<i class="fas fa-pen"></i> Edit Profile';
                editBtn.style.background = 'rgba(241, 245, 249, 0.8)';
                editBtn.style.color = 'var(--text-dark)';
                saveBtn.style.display = "none";
                saveBtn.innerText = "Save Changes";
                saveBtn.disabled = false;
                // alert("Profile Updated!"); // Replaced with visual feedback if possible, or keep simple

            } catch (error) {
                console.error("Error updating:", error);
                alert("Update failed.");
                saveBtn.innerText = "Save Changes";
                saveBtn.disabled = false;
            }
        });

        // Avatar Upload
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Optimistic update
            uAvatar.src = URL.createObjectURL(file);
            uAvatar.style.opacity = '0.5'; // Visual cue

            try {
                const storageRef = ref(storage, `user_photos/${currentUser.uid}/profile_${Date.now()}`);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);

                await updateDoc(doc(db, "users", currentUser.uid), {
                    photoURL: downloadURL
                });

                uAvatar.src = downloadURL;
                uAvatar.style.opacity = '1';
                // alert("Photo updated!");

            } catch (error) {
                console.error("Photo upload failed", error);
                alert("Failed to upload photo.");
                uAvatar.style.opacity = '1';
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            if(confirm("Are you sure you want to sign out?")) {
                await signOut(auth);
                window.location.href = 'index.html';
            }
        });

    </script>

    <!-- UI INTERACTION SCRIPT (Nav Auto-Hide & PWA) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Auto-Hide Bottom Nav Logic
            const bottomNav = document.getElementById('bottomNav');
            let lastScroll = 0;

            window.addEventListener('scroll', () => {
                const currentScroll = window.pageYOffset;
                
                if (currentScroll <= 0) {
                    bottomNav.classList.remove('hidden');
                } else {
                    if (currentScroll > lastScroll && currentScroll > 50) {
                        // Scrolling DOWN -> Hide
                        bottomNav.classList.add('hidden');
                    } else {
                        // Scrolling UP -> Show
                        bottomNav.classList.remove('hidden');
                    }
                }
                lastScroll = currentScroll;
            });
            
            if("serviceWorker" in navigator) {
                navigator.serviceWorker.register("./service-worker.js").catch(e => console.log("SW Error:", e));
            }
        });
    </script>
</body>
</html>
