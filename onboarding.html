<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- ZERO ZOOM: user-scalable=no, maximum-scale=1.0 locks the view -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Complete Profile | DuoGlobal</title>
    <meta name="theme-color" content="#0052CC">

    <!-- Performance Optimizations -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/images/icon-192.png">
    <link rel="apple-touch-icon" href="assets/images/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root {
            --primary-blue: #0052CC;
            --primary-dark: #003E99;
            --primary-gradient: linear-gradient(135deg, #0052CC 0%, #003380 100%);
            --accent-pink: #FF6B6B;
            --accent-glow: rgba(0, 82, 204, 0.2);
            --text-dark: #0f172a;
            --text-grey: #64748b;
            --bg-light: #f8fafc;
            
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.6);
            --error-red: #ef4444;
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color: transparent;}

        body {
            font-family: 'Inter', sans-serif;
            background: url('assets/images/background.png') repeat, var(--bg-light);
            background-size: 400px;
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
            overflow-x: hidden;
            overscroll-behavior-y: none;
            -webkit-font-smoothing: antialiased;
            opacity: 0;
            animation: fadeInPage 0.6s ease-out forwards;
        }

        @keyframes fadeInPage { to { opacity: 1; } }

        /* PRELOADER */
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .loader {
            width: 40px; height: 40px; border: 4px solid #e2e8f0;
            border-top-color: var(--primary-blue); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* ---- WIZARD CONTAINER ---- */
        .wizard-container {
            width: 100%; max-width: 580px; z-index: 10;
        }

        .wizard-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 32px;
            padding: 40px 48px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
            animation: slideUp 0.6s ease-out backwards;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        /* ---- LOGO AREA ---- */
        .brand-header {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
        }
        
        .logo-container {
            width: 80px;
            height: 80px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; 
        }

        .logo-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block; 
        }

        /* ---- PROGRESS BAR ---- */
        .progress-header { margin-bottom: 35px; text-align: center; }
        .progress-bar-bg { width: 100%; height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden; margin-top: 20px; }
        .progress-fill { height: 100%; background: var(--primary-gradient); width: 33%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 10px; }
        
        .step-title { font-family: 'Playfair Display', serif; font-size: 1.8rem; color: var(--text-dark); font-weight: 700; letter-spacing: -0.5px; }
        .step-desc { font-size: 0.95rem; color: var(--text-grey); margin-top: 6px; font-weight: 400; }

        /* ---- STEP CONTENT ---- */
        .step-content { display: none; opacity: 0; transition: opacity 0.4s ease, transform 0.4s ease; transform: translateX(10px); }
        .step-content.active { display: block; opacity: 1; transform: translateX(0); animation: slideIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }

        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* ---- FORMS ---- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .full-width { grid-column: 1 / -1; }
        
        .form-group { margin-bottom: 5px; position: relative; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: #334155; letter-spacing: 0.02em; }
        
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 14px 18px;
            border: 1px solid rgba(0,0,0,0.1); border-radius: 16px;
            font-size: 16px; /* 16px prevents iOS zoom on focus */
            font-family: 'Inter', sans-serif;
            transition: var(--transition); background: rgba(255,255,255,0.6);
            color: var(--text-dark);
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            appearance: none;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none; border-color: var(--primary-blue); background: #fff;
            box-shadow: 0 4px 12px rgba(0,82,204,0.1);
            transform: translateY(-1px);
        }
        .form-input.error, .form-textarea.error {
            border-color: var(--error-red);
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* ---- PHOTO UPLOAD ---- */
        .photo-upload-area {
            border: 2px dashed #cbd5e1; border-radius: 24px;
            padding: 40px; text-align: center; cursor: pointer;
            transition: all 0.3s ease; background: rgba(255,255,255,0.5);
            position: relative; overflow: hidden;
        }
        .photo-upload-area:hover { border-color: var(--primary-blue); background: rgba(0,82,204,0.03); transform: translateY(-2px); }
        
        .upload-icon { font-size: 3rem; color: #94a3b8; margin-bottom: 15px; transition: color 0.3s; }
        .photo-upload-area:hover .upload-icon { color: var(--primary-blue); }

        .upload-preview { 
            width: 140px; height: 140px; object-fit: cover; border-radius: 50%; 
            margin: 0 auto 15px; display: none; 
            border: 4px solid #fff; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        /* ---- NAV BUTTONS ---- */
        .wizard-footer { display: flex; justify-content: space-between; margin-top: 40px; align-items: center; }
        
        .btn-nav {
            padding: 14px 28px; border-radius: 100px; font-weight: 600; cursor: pointer; border: none; transition: var(--transition); font-size: 0.95rem;
            -webkit-touch-callout: none; user-select: none;
        }
        .btn-prev { background: transparent; color: var(--text-grey); padding-left: 0; }
        .btn-prev:hover { color: var(--text-dark); transform: translateX(-3px); }
        
        .btn-next { 
            background: var(--primary-gradient); color: white; display: flex; align-items: center; gap: 10px; 
            box-shadow: 0 10px 20px -5px rgba(0, 82, 204, 0.3);
        }
        .btn-next:hover { transform: translateY(-2px); box-shadow: 0 15px 25px -5px rgba(0, 82, 204, 0.4); }
        .btn-next:active { transform: translateY(0); }
        .btn-next:disabled { opacity: 0.7; cursor: wait; transform: none; box-shadow: none; }

        /* Spinner */
        .spinner { width: 20px; height: 20px; border: 2.5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s cubic-bezier(0.55, 0.055, 0.675, 0.19) infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 600px) {
            .wizard-card { padding: 30px 24px; border-radius: 24px; }
            .form-grid { grid-template-columns: 1fr; gap: 20px; }
            .step-title { font-size: 1.5rem; }
            body { padding: 15px; }
        }
    </style>
</head>
<body>

    <!-- Preloader -->
    <div id="preloader">
        <div class="loader"></div>
    </div>

    <div class="wizard-container">
        <div class="wizard-card">
            
            <!-- Logo Section -->
            <div class="brand-header">
                <div class="logo-container">
                    <img src="assets/images/logo.png" alt="DuoGlobal Logo" class="logo-img" onerror="this.style.display='none'; this.parentElement.style.background='var(--primary-gradient)'; this.parentElement.style.borderRadius='16px'; this.parentElement.innerHTML='<i class=\'fas fa-gem\' style=\'color:white; font-size:24px;\'></i>'">
                </div>
            </div>

            <!-- Progress Header -->
            <div class="progress-header">
                <h2 class="step-title" id="headerTitle">Personal Details</h2>
                <p class="step-desc" id="headerDesc">Tell us a bit about yourself.</p>
                <div class="progress-bar-bg">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
            </div>

            <!-- STEP 1: Personal Info -->
            <div class="step-content active" id="step1">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Date of Birth</label>
                        <input type="text" id="dob" class="form-input" placeholder="DD/MM/YY" maxlength="8" inputmode="numeric" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number (WhatsApp)</label>
                        <input type="tel" id="phone" class="form-input" placeholder="+1 234 567 890" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Country</label>
                        <input type="text" id="country" class="form-input" placeholder="e.g. Kenya" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">City</label>
                        <input type="text" id="city" class="form-input" placeholder="e.g. Nairobi" required>
                    </div>
                </div>
            </div>

            <!-- STEP 2: Profile Photo -->
            <div class="step-content" id="step2">
                <div class="full-width">
                    <label class="form-label" style="text-align: center; margin-bottom: 20px;">Upload a clear profile photo</label>
                    <div class="photo-upload-area" id="photoDropZone">
                        <img id="imgPreview" class="upload-preview" alt="Preview">
                        <div id="uploadPlaceholder">
                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                            <h3 style="font-size: 1.1rem; font-weight: 600; color: #475569; margin-bottom: 5px;">Upload Photo</h3>
                            <p style="font-size: 0.9rem; color: #64748b;">Tap to browse or drag here</p>
                            <p style="font-size: 0.75rem; color: #94a3b8; margin-top: 8px;">Optimized auto-compression enabled</p>
                        </div>
                        <input type="file" id="fileInput" accept="image/*" style="display: none;">
                    </div>
                </div>
            </div>

            <!-- STEP 3: Bio & Interests -->
            <div class="step-content" id="step3">
                <div class="form-group">
                    <label class="form-label">Occupation</label>
                    <input type="text" id="occupation" class="form-input" placeholder="e.g. Nurse, Entrepreneur">
                </div>
                <div class="form-group">
                    <label class="form-label">About Me (Bio)</label>
                    <textarea id="bio" class="form-textarea" rows="5" placeholder="Describe your personality, hobbies, and what you are looking for..."></textarea>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="wizard-footer">
                <button type="button" class="btn-nav btn-prev" id="prevBtn" style="visibility: hidden;">Back</button>
                <button type="button" class="btn-nav btn-next" id="nextBtn">
                    <span id="nextText">Next Step</span>
                    <i class="fas fa-arrow-right" id="nextIcon" style="font-size: 0.8rem;"></i>
                    <div class="spinner" id="spinner"></div>
                </button>
            </div>

        </div>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { auth, db, storage } from './config.js'; 
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';
        import { doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js';
        import { ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-storage.js';

        // State Variables
        let currentStep = 1;
        const totalSteps = 3;
        let currentUser = null;
        let selectedFile = null;

        // Elements
        const steps = [document.getElementById('step1'), document.getElementById('step2'), document.getElementById('step3')];
        const progressBar = document.getElementById('progressBar');
        const headerTitle = document.getElementById('headerTitle');
        const headerDesc = document.getElementById('headerDesc');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const nextText = document.getElementById('nextText');
        const nextIcon = document.getElementById('nextIcon');
        const spinner = document.getElementById('spinner');
        const preloader = document.getElementById('preloader');

        // Remove Preloader
        window.addEventListener('load', () => {
            preloader.style.opacity = '0';
            setTimeout(() => preloader.style.display = 'none', 500);
        });

        // Check Auth on Load
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
            } else {
                window.location.href = 'login.html';
            }
        });

        // ----- DATE FORMATTER (DD/MM/YY) -----
        const dobInput = document.getElementById('dob');
        dobInput.addEventListener('input', function(e) {
            let input = e.target.value;
            // Remove non-numeric chars
            input = input.replace(/\D/g, ''); 
            
            // Limit to 6 digits (DD MM YY)
            if (input.length > 6) input = input.substring(0, 6);

            // Add slashes
            let formatted = '';
            if (input.length > 0) {
                formatted = input.substring(0, 2);
            }
            if (input.length >= 3) {
                formatted += '/' + input.substring(2, 4);
            }
            if (input.length >= 5) {
                formatted += '/' + input.substring(4, 6);
            }
            
            e.target.value = formatted;
        });

        // ----- EVENT LISTENERS -----
        
        nextBtn.addEventListener('click', handleNext);
        prevBtn.addEventListener('click', handlePrev);

        // Photo Upload Logic
        const dropZone = document.getElementById('photoDropZone');
        const fileInput = document.getElementById('fileInput');
        
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#0052CC'; });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.borderColor = '#cbd5e1'; });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#cbd5e1';
            if(e.dataTransfer.files[0]) handleFileSelect(e.dataTransfer.files[0]);
        });
        
        fileInput.addEventListener('change', (e) => {
            if(e.target.files[0]) handleFileSelect(e.target.files[0]);
        });

        async function handleFileSelect(file) {
            // Validation
            if (!file.type.startsWith('image/')) { alert("Please select an image file."); return; }
            
            // Client-side compression for speed (Max width 1024px)
            try {
                const compressedFile = await compressImage(file, 1024, 0.8);
                selectedFile = compressedFile;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('imgPreview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    document.getElementById('uploadPlaceholder').style.display = 'none';
                };
                reader.readAsDataURL(compressedFile);
            } catch (err) {
                console.error("Compression error:", err);
                selectedFile = file;
            }
        }

        // Image Compression Helper
        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            if (!blob) reject(new Error('Canvas is empty'));
                            const newFile = new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now(),
                            });
                            resolve(newFile);
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        }

        // ----- NAVIGATION LOGIC -----

        async function handleNext() {
            if (currentStep === 1) {
                if (!validateStep1()) return;
                changeStep(2);
            } else if (currentStep === 2) {
                if (!selectedFile) { alert("Please upload a photo to continue."); return; }
                changeStep(3);
            } else if (currentStep === 3) {
                if (!validateStep3()) return;
                await submitProfile();
            }
        }

        function handlePrev() {
            if (currentStep > 1) {
                changeStep(currentStep - 1);
            }
        }

        function changeStep(step) {
            steps[currentStep - 1].classList.remove('active');
            
            setTimeout(() => {
                currentStep = step;
                steps[currentStep - 1].classList.add('active');
                updateUI();
            }, 100);
        }

        function updateUI() {
            const percent = ((currentStep / totalSteps) * 100) + '%';
            progressBar.style.width = percent;

            prevBtn.style.visibility = currentStep === 1 ? 'hidden' : 'visible';
            
            if (currentStep === 3) {
                nextText.innerText = "Complete";
                nextIcon.classList.remove('fa-arrow-right');
                nextIcon.classList.add('fa-check');
            } else {
                nextText.innerText = "Next Step";
                nextIcon.classList.remove('fa-check');
                nextIcon.classList.add('fa-arrow-right');
            }

            if(currentStep === 1) {
                headerTitle.innerText = "Personal Details";
                headerDesc.innerText = "Let's start with the basics.";
            } else if(currentStep === 2) {
                headerTitle.innerText = "Your Look";
                headerDesc.innerText = "A good photo increases matches by 80%.";
            } else if(currentStep === 3) {
                headerTitle.innerText = "Your Story";
                headerDesc.innerText = "What makes you, you?";
            }
        }

        // ----- VALIDATION -----

        function validateStep1() {
            const requiredIds = ['dob', 'phone', 'country', 'city'];
            let isValid = true;
            
            // Date specific check
            const dob = document.getElementById('dob');
            if(dob.value.length !== 8) { // DD/MM/YY = 8 chars
                dob.classList.add('error');
                isValid = false;
            }

            for (let id of requiredIds) {
                const el = document.getElementById(id);
                el.classList.remove('error');
                if (!el.value.trim()) {
                    el.classList.add('error');
                    if(isValid) el.focus();
                    isValid = false;
                }
            }
            if(!isValid) return false;
            return true;
        }

        function validateStep3() {
            const bio = document.getElementById('bio');
            bio.classList.remove('error');
            if (!bio.value.trim()) {
                bio.classList.add('error');
                bio.focus();
                alert("Please enter a short bio.");
                return false;
            }
            return true;
        }

        // ----- SUBMISSION LOGIC -----

        async function submitProfile() {
            setLoading(true);

            try {
                // 1. Upload Image
                let photoURL = "";
                if (selectedFile) {
                    const timestamp = Date.now();
                    const storageRef = ref(storage, `user_photos/${currentUser.uid}/profile_${timestamp}.jpg`);
                    await uploadBytes(storageRef, selectedFile);
                    photoURL = await getDownloadURL(storageRef);
                }

                // 2. Gather Data
                const profileData = {
                    dob: document.getElementById('dob').value, // This will be saved as string "DD/MM/YY"
                    phone: document.getElementById('phone').value,
                    country: document.getElementById('country').value,
                    city: document.getElementById('city').value,
                    occupation: document.getElementById('occupation').value || 'Unspecified',
                    bio: document.getElementById('bio').value,
                    photoURL: photoURL,
                    profileCompleted: true,
                    updatedAt: serverTimestamp(),
                    userId: currentUser.uid 
                };

                // 3. Write to Firestore
                const userRef = doc(db, "users", currentUser.uid);
                await setDoc(userRef, profileData, { merge: true });

                window.location.href = 'dashboard.html';

            } catch (error) {
                console.error("Error saving profile:", error);
                
                if(error.code === 'permission-denied') {
                    alert("Access denied. Please ensure you are logged in correctly.");
                } else {
                    alert("Error saving profile. Please check your internet connection.");
                }
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            if(isLoading) {
                nextBtn.disabled = true;
                nextText.style.display = 'none';
                nextIcon.style.display = 'none';
                spinner.style.display = 'block';
            } else {
                nextBtn.disabled = false;
                nextText.style.display = 'block';
                nextIcon.style.display = 'block';
                spinner.style.display = 'none';
            }
        }
    </script>
</body>
</html>
