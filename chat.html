<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Messages | DuoGlobal</title>

  <meta name="theme-color" content="#0052CC" />
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
  
  <!-- PWA Manifest & Icons -->
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="assets/images/icon-192.png">
  <link rel="apple-touch-icon" href="assets/images/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root {
      --primary-blue: #0052cc;
      --primary-dark: #003e99;
      --primary-gradient: linear-gradient(135deg, #0052CC 0%, #003380 100%);
      --accent-pink: #ff6b6b;
      --bg-light: #f8fafc;
      --text-dark: #1e293b;
      --text-grey: #64748b;
      --white: #ffffff;
      
      --glass-bg: rgba(255, 255, 255, 0.95);
      --shadow-card: 0 10px 30px rgba(0,0,0,0.06);
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Inter", sans-serif;
      background: url('assets/images/background.png') repeat, var(--bg-light);
      background-size: 400px;
      color: var(--text-dark);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden; /* Prevent body scroll */
      -webkit-font-smoothing: antialiased;
      opacity: 0;
      animation: fadeInPage 0.6s ease-out forwards;
    }

    @keyframes fadeInPage { to { opacity: 1; } }

    /* PRELOADER */
    #preloader {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #fff; z-index: 9999;
        display: flex; justify-content: center; align-items: center;
        transition: opacity 0.5s ease;
    }
    .loader {
        width: 40px; height: 40px; border: 4px solid #e2e8f0;
        border-top-color: var(--primary-blue); border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.03);
      padding: 15px 20px;
      font-weight: 700;
      font-family: 'Playfair Display', serif;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-blue);
      animation: slideDown 0.6s ease-out;
    }

    main {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
    }

    /* SIDEBAR - Chat List */
    .chat-list {
      width: 35%;
      max-width: 400px;
      border-right: 1px solid rgba(0,0,0,0.05);
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      animation: slideInLeft 0.6s ease-out;
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid rgba(0,0,0,0.03);
      cursor: pointer;
      transition: var(--transition);
    }
    .chat-item:hover {
      background: rgba(255,255,255,0.95);
      padding-left: 25px;
    }
    .chat-item.active {
      background: #eff6ff;
      border-left: 4px solid var(--primary-blue);
    }

    .chat-item img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 15px;
      border: 2px solid white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .chat-name {
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 3px;
      color: var(--text-dark);
    }
    .chat-last {
      color: var(--text-grey);
      font-size: 0.8rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 180px;
    }

    /* CHAT WINDOW */
    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(248, 250, 252, 0.5);
      position: relative;
    }

    .chat-header {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0,0,0,0.05);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10;
    }

    .chat-header img {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .chat-header h3 {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-dark);
    }

    .messages {
      flex: 1;
      padding: 20px;
      padding-bottom: 100px; /* Space for input & nav */
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .msg {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.5;
      font-size: 0.95rem;
      word-break: break-word;
      position: relative;
      animation: fadeIn 0.3s ease-out;
      box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    }

    .msg.you {
      align-self: flex-end;
      background: var(--primary-gradient);
      color: white;
      border-bottom-right-radius: 4px;
    }
    .msg.them {
      background: white;
      align-self: flex-start;
      color: var(--text-dark);
      border-bottom-left-radius: 4px;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .timestamp {
      font-size: 0.65rem;
      opacity: 0.7;
      margin-top: 4px;
      text-align: right;
    }
    .msg.them .timestamp { text-align: left; }

    /* INPUT AREA */
    .input-area {
      position: absolute;
      bottom: 20px; /* Adjust for bottom nav if on mobile */
      left: 0; right: 0;
      display: flex;
      align-items: center;
      padding: 15px;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0,0,0,0.05);
      z-index: 50;
      transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .input-area.shifted { transform: translateY(100%); } /* Hide when nav hides on mobile */

    .message-input {
      flex: 1;
      border: 1px solid rgba(0,0,0,0.1);
      outline: none;
      background: #f8fafc;
      border-radius: 25px;
      padding: 12px 20px;
      font-size: 0.95rem;
      transition: var(--transition);
    }
    .message-input:focus {
        background: white;
        border-color: var(--primary-blue);
        box-shadow: 0 4px 15px rgba(0,82,204,0.1);
    }

    .send-btn {
      border: none;
      background: var(--primary-gradient);
      color: white;
      width: 45px; height: 45px;
      border-radius: 50%;
      margin-left: 12px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: var(--transition);
      box-shadow: 0 4px 10px rgba(0,82,204,0.3);
    }

    .send-btn:hover { transform: scale(1.1); }
    .send-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    /* MOBILE ADAPTATION */
    @media (max-width: 768px) {
      .chat-list {
        display: none; /* In a real app, you'd toggle between list/detail view */
        width: 100%;
        max-width: none;
      }
      /* For demo simplicity, hiding list on mobile to show chat window, 
         typically you'd have a back button */
      .input-area { bottom: 80px; } /* Lift above bottom nav */
    }

    /* BOTTOM NAV (Auto-Hide) */
    .bottom-nav {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: 92%; max-width: 500px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 25px; border-radius: 30px; z-index: 999;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.5);
      transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .bottom-nav.hidden { transform: translateX(-50%) translateY(200%); }

    .nav-item {
      text-decoration: none;
      color: #94a3b8;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      font-size: 0.7rem;
      font-weight: 600;
      transition: 0.3s;
      flex: 1;
    }
    .nav-item i { font-size: 1.3rem; transition: 0.3s; }
    .nav-item.active { color: var(--primary-blue); }
    .nav-item:hover { color: var(--primary-blue); }
    .nav-item:hover i { transform: translateY(-2px); }

    /* Animations */
    @keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInLeft { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <!-- Preloader -->
  <div id="preloader">
      <div class="loader"></div>
  </div>

  <header id="pageHeader">
    <span>Messages</span>
  </header>

  <main>
    <aside class="chat-list" id="chatList">
      <div style="padding:30px; color:#94a3b8; text-align:center;">
          <i class="fas fa-spinner fa-spin"></i> Loading...
      </div>
    </aside>

    <section class="chat-window">
      <div class="chat-header" id="chatHeader">
        <img src="assets/images/placeholder-man.jpg" id="chatAvatar" alt="">
        <h3 id="chatName">Select a Connection</h3>
      </div>
      
      <div class="messages" id="messagesArea">
        <div style="text-align:center; margin-top:40px; color:#94a3b8; opacity:0.8;">
            <i class="fas fa-comments" style="font-size:3rem; margin-bottom:15px; color:#cbd5e1;"></i>
            <p>Select a chat from the left to start messaging</p>
        </div>
      </div>
      
      <form class="input-area" id="chatForm">
        <input type="text" id="messageInput" class="message-input" placeholder="Type a message..." disabled />
        <button type="submit" class="send-btn" disabled><i class="fas fa-paper-plane"></i></button>
      </form>
    </section>
  </main>

  <!-- Bottom Navigation (Auto-Hide) -->
  <nav class="bottom-nav" id="bottomNav">
    <a href="index.html" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
    <a href="dashboard.html" class="nav-item"><i class="fas fa-search"></i><span>Browse</span></a>
    <a href="my-connections.html" class="nav-item"><i class="fas fa-heart"></i><span>Matches</span></a>
    <a href="chat.html" class="nav-item active"><i class="fas fa-comment-dots"></i><span>Chat</span></a>
    <a href="user-profile.html" class="nav-item"><i class="fas fa-user-circle"></i><span>Profile</span></a>
  </nav>

  <!-- FIREBASE SCRIPT -->
  <script type="module">
    import { auth, db } from './config.js';
    import {
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';
    import {
      collection,
      query,
      where,
      getDocs,
      orderBy,
      addDoc,
      doc,
      getDoc,
      onSnapshot,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js';

    const chatList = document.getElementById('chatList');
    const chatName = document.getElementById('chatName');
    const chatAvatar = document.getElementById('chatAvatar');
    const messagesArea = document.getElementById('messagesArea');
    const messageInput = document.getElementById('messageInput');
    const chatForm = document.getElementById('chatForm');
    const sendBtn = document.querySelector('.send-btn');
    const preloader = document.getElementById('preloader');

    // Remove Preloader
    window.addEventListener('load', () => {
        preloader.style.opacity = '0';
        setTimeout(() => preloader.style.display = 'none', 500);
    });

    let currentUser = null;
    let selectedProfile = null;
    let unsubscribeMessages = null;

    // AUTH CHECK
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        loadChatList(user.uid);
      } else {
        window.location.href = 'login.html';
      }
    });

    async function loadChatList(uid) {
      try {
        const q = query(
          collection(db, 'connections'),
          where('userId', '==', uid),
          where('status', '==', 'unlocked')
        );
        const connSnap = await getDocs(q);
        if (connSnap.empty) {
          chatList.innerHTML =
            '<div style="padding:40px;text-align:center;color:#94a3b8;"><i class="fas fa-user-slash" style="font-size:2rem;margin-bottom:10px;"></i><br>No connections yet</div>';
          return;
        }

        chatList.innerHTML = '';
        for (const conn of connSnap.docs) {
          const data = conn.data();
          const profileRef = doc(db, 'men_profiles', data.profileId);
          const profileSnap = await getDoc(profileRef);
          if (profileSnap.exists()) {
            const p = profileSnap.data();
            renderChatListItem(data.profileId, p);
          }
        }
      } catch (err) {
        console.error(err);
        chatList.innerHTML =
          '<div style="padding:20px;color:red;">Error loading chats</div>';
      }
    }

    function renderChatListItem(profileId, profile) {
      const item = document.createElement('div');
      item.className = 'chat-item';
      item.innerHTML = `
        <img src="${profile.photoURL || 'assets/images/placeholder-man.jpg'}" alt="">
        <div>
            <div class="chat-name">${profile.occupation ?? 'Contact'}</div>
            <div class="chat-last" id="last_${profileId}">Start a conversation...</div>
        </div>
      `;
      item.addEventListener('click', () => {
          // Highlight active
          document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
          item.classList.add('active');
          openChat(profileId, profile);
      });
      chatList.appendChild(item);
    }

    async function openChat(profileId, profile) {
      selectedProfile = { id: profileId, ...profile };
      chatName.textContent = profile.occupation ?? 'Conversation';
      chatAvatar.src = profile.photoURL || 'assets/images/placeholder-man.jpg';
      messageInput.disabled = false;
      sendBtn.disabled = false;
      messagesArea.innerHTML = ''; // Clear previous messages

      // Unsubscribe old chat stream
      if (unsubscribeMessages) unsubscribeMessages();

      const chatId = [currentUser.uid, profileId].sort().join('_');

      const msgQuery = query(
        collection(db, 'messages', chatId, 'thread'),
        orderBy('timestamp', 'asc')
      );

      unsubscribeMessages = onSnapshot(msgQuery, (snapshot) => {
        messagesArea.innerHTML = '';
        if(snapshot.empty) {
            messagesArea.innerHTML = '<div style="text-align:center; margin-top:40px; color:#94a3b8; font-size:0.9rem;">Say hello! ðŸ‘‹</div>';
        }
        
        snapshot.forEach((doc) => {
          const msg = doc.data();
          renderMessage(msg);
        });
        messagesArea.scrollTop = messagesArea.scrollHeight;
      });
    }

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text || !selectedProfile) return;

      const chatId = [currentUser.uid, selectedProfile.id].sort().join(
        '_'
      );

      await addDoc(collection(db, 'messages', chatId, 'thread'), {
        from: currentUser.uid,
        to: selectedProfile.id,
        text: text,
        timestamp: serverTimestamp(),
      });
      messageInput.value = '';
    });

    function renderMessage(msg) {
      const isOwn = msg.from === currentUser.uid;
      const div = document.createElement('div');
      div.className = `msg ${isOwn ? 'you' : 'them'}`;
      div.innerHTML = `
        ${msg.text}
        <div class="timestamp">${msg.timestamp
          ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], {
              hour: '2-digit',
              minute: '2-digit',
            })
          : '...'}</div>
      `;
      messagesArea.appendChild(div);
    }
  </script>

  <!-- UI INTERACTION SCRIPT (Nav Auto-Hide & PWA) -->
  <script>
      document.addEventListener('DOMContentLoaded', () => {
          // Auto-Hide Header & Bottom Nav Logic
          const bottomNav = document.getElementById('bottomNav');
          const header = document.getElementById('pageHeader');
          // const inputArea = document.getElementById('chatForm'); // Optional to hide input

          let lastScroll = 0;

          // Note: In this specific layout, `window` scroll might not trigger if main/messages scroll
          // We need to detect scroll on the messages container if we wanted to hide nav based on message scrolling
          // But usually, hiding nav happens on body scroll. Since body is fixed height here, this might not fire often.
          // However, for consistency with other pages:
          
          window.addEventListener('scroll', () => {
              const currentScroll = window.pageYOffset;
              
              if (currentScroll <= 0) {
                  bottomNav.classList.remove('hidden');
                  header.classList.remove('hidden');
              } else {
                  if (currentScroll > lastScroll && currentScroll > 50) {
                      bottomNav.classList.add('hidden');
                      header.style.transform = 'translateY(-100%)';
                  } else {
                      bottomNav.classList.remove('hidden');
                      header.style.transform = 'translateY(0)';
                  }
              }
              lastScroll = currentScroll;
          });
          
          if("serviceWorker" in navigator) {
              navigator.serviceWorker.register("./service-worker.js").catch(e => console.log("SW Error:", e));
          }
      });
  </script>

</body>
</html>
