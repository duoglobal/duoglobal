<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Manage Users | DuoGlobal Admin</title>
    <meta name="theme-color" content="#0052CC">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/images/icon-192.png">
    <link rel="apple-touch-icon" href="assets/images/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root {
            --primary: #0052CC;
            --primary-dark: #003E99;
            --primary-gradient: linear-gradient(135deg, #0052CC 0%, #003380 100%);
            --bg-light: #f8fafc;
            --white: #ffffff;
            --text-dark: #1e293b;
            --text-grey: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #166534;
            
            --glass-bg: rgba(255, 255, 255, 0.95);
            --shadow-card: 0 10px 30px rgba(0,0,0,0.06);
            --shadow-float: 0 10px 30px rgba(0,82,204,0.3);
            --border-radius: 20px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {margin:0;padding:0;box-sizing:border-box;}

        body {
            font-family: 'Inter', sans-serif;
            background: url('assets/images/background.png') repeat, var(--bg-light);
            background-size: 400px;
            color: var(--text-dark);
            min-height: 100vh;
            padding: 30px;
            padding-bottom: 120px; /* Space for bottom nav */
            -webkit-font-smoothing: antialiased;
            opacity: 0;
            animation: fadeInPage 0.6s ease-out forwards;
        }

        @keyframes fadeInPage { to { opacity: 1; } }

        /* PRELOADER */
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .loader {
            width: 40px; height: 40px; border: 4px solid var(--border);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .header h1 { 
            font-size: 1.8rem; font-weight: 700; color: var(--text-dark);
            letter-spacing: -0.5px;
        }
        .btn-back {
            text-decoration: none;
            color: var(--text-grey);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            padding: 8px 12px;
            border-radius: 8px;
        }
        .btn-back:hover { color: var(--primary); background: rgba(0,82,204,0.05); }

        /* SEARCH BAR */
        .toolbar {
            display: flex; gap: 15px; margin-bottom: 25px;
            max-width: 1200px; margin: 0 auto 25px;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s backwards;
        }
        .search-wrapper {
            position: relative; flex: 1;
        }
        .search-input {
            width: 100%; padding: 14px 15px 14px 45px;
            border-radius: 12px; border: 1px solid var(--border);
            background: var(--glass-bg); font-size: 0.95rem; font-family: inherit;
            transition: var(--transition); box-shadow: var(--shadow-card);
            backdrop-filter: blur(10px);
        }
        .search-input:focus { 
            outline: none; border-color: var(--primary); 
            box-shadow: 0 4px 20px rgba(0,82,204,0.15); 
            transform: translateY(-2px);
        }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-grey); }

        .btn-refresh {
            background: var(--glass-bg); border: 1px solid var(--border);
            color: var(--primary); border-radius: 12px; width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: var(--shadow-card); transition: var(--transition);
            font-size: 1.1rem;
        }
        .btn-refresh:hover { 
            background: var(--primary); color: white; border-color: var(--primary); 
            transform: rotate(180deg);
        }

        /* TABLE CONTAINER */
        .table-card {
            background: var(--glass-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(255,255,255,0.8);
            overflow: hidden;
            max-width: 1200px; margin: 0 auto;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.2s backwards;
            backdrop-filter: blur(10px);
        }
        .table-responsive { overflow-x: auto; }
        
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        
        th {
            text-align: left; padding: 18px 24px;
            background: rgba(248, 250, 252, 0.8); border-bottom: 1px solid var(--border);
            color: var(--text-grey); font-size: 0.8rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        td {
            padding: 20px 24px; border-bottom: 1px solid var(--border);
            font-size: 0.95rem; vertical-align: middle; color: var(--text-dark);
            transition: background 0.2s;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(241, 245, 249, 0.5); }

        /* USER CELL */
        .user-cell { display: flex; align-items: center; gap: 15px; }
        .user-avatar { 
            width: 44px; height: 44px; border-radius: 50%; 
            object-fit: cover; border: 2px solid var(--white); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .user-info h4 { font-size: 0.95rem; font-weight: 600; margin-bottom: 2px; }
        .user-info p { font-size: 0.8rem; color: var(--text-grey); }

        /* BADGES & BUTTONS */
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: inline-block; letter-spacing: 0.3px; }
        .badge-active { background: #dcfce7; color: var(--success); }
        .badge-inactive { background: #fee2e2; color: var(--danger); }

        .action-btn {
            background: transparent; border: 1px solid var(--border);
            width: 36px; height: 36px; border-radius: 10px;
            color: var(--text-grey); cursor: pointer; transition: var(--transition);
            display: inline-flex; align-items: center; justify-content: center;
            margin-left: 6px;
        }
        .action-btn:hover { background: #eff6ff; color: var(--primary); border-color: #dbeafe; transform: translateY(-2px); }
        .action-btn.delete:hover { background: #fef2f2; color: var(--danger); border-color: #fee2e2; }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: rgba(255,255,255,0.95); padding: 30px; border-radius: 24px; width: 90%; max-width: 450px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            animation: modalPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid rgba(255,255,255,0.5);
        }
        @keyframes modalPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .modal-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 15px; color: var(--text-dark); }
        .modal-body { font-size: 0.95rem; color: #475569; margin-bottom: 25px; line-height: 1.6; }
        
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .btn-modal { padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; font-size: 0.95rem; transition: var(--transition); }
        .btn-cancel { background: #f1f5f9; color: var(--text-dark); }
        .btn-cancel:hover { background: #e2e8f0; }
        .btn-confirm { background: var(--danger); color: white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
        .btn-confirm:hover { background: #dc2626; transform: translateY(-2px); }

        /* BOTTOM NAV (Auto-Hide) */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 500px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 25px; border-radius: 30px; z-index: 9999;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.5);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .bottom-nav.hidden { transform: translateX(-50%) translateY(200%); }

        .nav-item { 
            text-decoration: none; color: #94a3b8; display: flex; flex-direction: column; 
            align-items: center; gap: 5px; font-size: 0.7rem; font-weight: 600; transition: 0.3s;
            flex: 1;
        }
        .nav-item i { font-size: 1.3rem; transition: 0.3s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-3px); filter: drop-shadow(0 4px 6px rgba(0,82,204,0.2)); }
        
        .nav-item-center {
            background: var(--primary-gradient); width: 54px; height: 54px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white; margin-top: -30px; 
            box-shadow: var(--shadow-float); border: 4px solid rgba(255,255,255,0.2);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .nav-item-center:hover { transform: scale(1.1) translateY(-5px); }
        .nav-item-center i { font-size: 1.5rem; }

        /* Hide floating button smoothly with nav */
        .bottom-nav.hidden .nav-item-center { transform: scale(0); }

        /* Animations */
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.5rem; }
            .search-input { padding-top: 12px; padding-bottom: 12px; }
        }
    </style>
</head>
<body>

    <!-- Preloader -->
    <div id="preloader">
        <div class="loader"></div>
    </div>

    <!-- Header -->
    <div class="header">
        <h1>Manage Users</h1>
        <a href="admin-dashboard.html" class="btn-back"><i class="fas fa-arrow-left"></i> Dashboard</a>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="search-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Search by name, email, or ID...">
        </div>
        <button class="btn-refresh" id="refreshBtn" title="Refresh Data">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    <!-- Data Table -->
    <div class="table-card">
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>User Profile</th>
                        <th>Location</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Joined</th>
                        <th style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; color: #64748b; padding: 40px;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; color: var(--primary);"></i> <br><br> Loading users...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Template -->
    <div class="modal-overlay" id="userModal">
        <div class="modal-box">
            <h3 class="modal-title" id="modalTitle">Details</h3>
            <div class="modal-body" id="modalBody">
                <!-- Injected via JS -->
            </div>
            <div class="modal-actions" id="modalActions">
                <button class="btn-modal btn-cancel" id="closeModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" id="bottomNav">
        <a href="admin-dashboard.html" class="nav-item">
            <i class="fas fa-home"></i> <span>Home</span>
        </a>
        <a href="admin-users.html" class="nav-item active">
            <i class="fas fa-users"></i> <span>Users</span>
        </a>
        <a href="admin-add-profile.html" class="nav-item-center">
            <i class="fas fa-plus"></i>
        </a>
        <a href="admin-settings.html" class="nav-item">
            <i class="fas fa-cog"></i> <span>Settings</span>
        </a>
    </nav>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { auth, db } from './config.js'; 
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';
        import { collection, getDocs, doc, getDoc, query, orderBy, deleteDoc } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js';

        const tableBody = document.getElementById('usersTableBody');
        const searchInput = document.getElementById('searchInput');
        const refreshBtn = document.getElementById('refreshBtn');
        const userModal = document.getElementById('userModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const preloader = document.getElementById('preloader');

        let allUsers = []; 

        // Remove Preloader
        window.addEventListener('load', () => {
            preloader.style.opacity = '0';
            setTimeout(() => preloader.style.display = 'none', 500);
        });

        // 1. Auth Guard
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const uDoc = await getDoc(doc(db, "users", user.uid));
                    if (uDoc.exists() && uDoc.data().role === 'admin') {
                        fetchUsers();
                    } else {
                        window.location.href = 'index.html';
                    }
                } catch (e) {
                    console.error("Auth Error", e);
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        // 2. Fetch Users
        async function fetchUsers() {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#64748b;"><i class="fas fa-spinner fa-spin" style="font-size:1.5rem; color:var(--primary);"></i><br><br>Refreshing...</td></tr>';
            
            try {
                const q = query(collection(db, "users"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                allUsers = [];
                querySnapshot.forEach((doc) => {
                    allUsers.push({ id: doc.id, ...doc.data() });
                });

                renderTable(allUsers);
            } catch (error) {
                console.error("Error fetching users:", error);
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#ef4444; padding:30px;">Failed to load data.</td></tr>';
            }
        }

        // 3. Render Table
        function renderTable(users) {
            tableBody.innerHTML = '';
            
            if(users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; font-style:italic;">No users found.</td></tr>';
                return;
            }

            users.forEach((user, index) => {
                const img = user.photoURL || 'assets/images/placeholder-woman.png';
                const name = user.fullName || 'No Name';
                const email = user.email || 'No Email';
                const loc = `${user.city || ''} ${user.country || ''}`.trim() || 'Unknown';
                const role = user.role || 'user';
                const date = user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString() : 'N/A';
                
                // Determine Badge
                const verifiedBadge = user.profileCompleted 
                    ? '<span class="badge badge-active">Active</span>' 
                    : '<span class="badge badge-inactive">Pending</span>';

                // Stagger animation for table rows
                const delay = index * 0.05; 
                
                const row = `
                    <tr style="opacity: 0; animation: slideUp 0.4s ease forwards ${delay}s;">
                        <td>
                            <div class="user-cell">
                                <img src="${img}" class="user-avatar" alt="Avatar">
                                <div class="user-info">
                                    <h4>${escapeHtml(name)}</h4>
                                    <p>${escapeHtml(email)}</p>
                                </div>
                            </div>
                        </td>
                        <td>${escapeHtml(loc)}</td>
                        <td style="text-transform: capitalize;">${escapeHtml(role)}</td>
                        <td>${verifiedBadge}</td>
                        <td style="color:#64748b;">${date}</td>
                        <td style="text-align: right; white-space: nowrap;">
                            <button class="action-btn" onclick="window.viewUser('${user.id}')" title="View Details"><i class="fas fa-eye"></i></button>
                            <button class="action-btn delete" onclick="window.confirmDelete('${user.id}', '${escapeHtml(name)}')" title="Delete User"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        // 4. Search
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allUsers.filter(u => 
                (u.fullName && u.fullName.toLowerCase().includes(term)) ||
                (u.email && u.email.toLowerCase().includes(term)) ||
                (u.id && u.id.toLowerCase().includes(term))
            );
            renderTable(filtered);
        });

        refreshBtn.addEventListener('click', () => {
             refreshBtn.style.transform = "rotate(360deg)";
             setTimeout(() => refreshBtn.style.transform = "none", 500);
             fetchUsers();
        });

        // 5. Modal Logic
        window.viewUser = (id) => {
            const user = allUsers.find(u => u.id === id);
            if(!user) return;

            document.getElementById('modalTitle').innerText = "User Profile";
            document.getElementById('modalBody').innerHTML = `
                <div style="text-align:center; margin-bottom:20px;">
                    <img src="${user.photoURL || 'assets/images/placeholder-woman.png'}" style="width:80px; height:80px; border-radius:50%; object-fit:cover; border:3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                    <h4 style="margin-top:12px; font-size:1.2rem; font-weight:700;">${user.fullName}</h4>
                    <p style="color:#64748b; font-size:0.9rem;">${user.email}</p>
                </div>
                <div style="background:#f8fafc; padding:20px; border-radius:12px; font-size:0.9rem; border: 1px solid #e2e8f0;">
                    <p style="margin-bottom:8px;"><strong>User Role:</strong> <span style="text-transform:capitalize; color:var(--primary); font-weight:600;">${user.role || 'User'}</span></p>
                    <p style="margin-bottom:8px;"><strong>Phone:</strong> ${user.phone || 'N/A'}</p>
                    <p style="margin-bottom:8px;"><strong>Occupation:</strong> ${user.occupation || 'N/A'}</p>
                    <p style="line-height:1.5;"><strong>Bio:</strong> ${user.bio || 'No bio available.'}</p>
                </div>
                <p style="margin-top:15px; font-size:0.75rem; color:#94a3b8; text-align:center; font-family:monospace;">UUID: ${user.id}</p>
            `;
            
            // Reset modal buttons
            const actions = document.getElementById('modalActions');
            actions.innerHTML = `<button class="btn-modal btn-cancel" id="closeModalBtnLocal">Close</button>`;
            document.getElementById('closeModalBtnLocal').onclick = () => userModal.style.display = 'none';
            
            userModal.style.display = 'flex';
        };

        window.confirmDelete = (id, name) => {
            document.getElementById('modalTitle').innerText = "Confirm Deletion";
            document.getElementById('modalBody').innerHTML = `
                <div style="text-align:center; padding:10px;">
                    <div style="width:70px; height:70px; background:#fef2f2; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; animation: bounce 0.5s;">
                        <i class="fas fa-exclamation-triangle" style="font-size:2rem; color:var(--danger);"></i>
                    </div>
                    <p style="font-size:1.05rem;">Are you sure you want to permanently delete <strong>${name}</strong>?</p>
                    <p style="font-size:0.85rem; color:#64748b; margin-top:8px;">This action cannot be undone and will remove all associated data.</p>
                </div>
            `;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn-modal btn-confirm';
            deleteBtn.innerText = 'Delete User';
            deleteBtn.onclick = async () => {
                deleteBtn.innerText = "Processing...";
                deleteBtn.disabled = true;
                deleteBtn.style.opacity = "0.7";
                try {
                    await deleteDoc(doc(db, "users", id));
                    userModal.style.display = 'none';
                    fetchUsers(); 
                } catch (err) {
                    alert("Error: " + err.message);
                }
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn-modal btn-cancel';
            cancelBtn.innerText = 'Cancel';
            cancelBtn.onclick = () => userModal.style.display = 'none';

            const actions = document.getElementById('modalActions');
            actions.innerHTML = '';
            actions.appendChild(cancelBtn);
            actions.appendChild(deleteBtn);

            userModal.style.display = 'flex';
        };

        closeModalBtn.addEventListener('click', () => {
            userModal.style.display = 'none';
        });

        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

    </script>

    <!-- Auto-Hide Bottom Nav Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bottomNav = document.getElementById('bottomNav');
            let lastScroll = 0;

            window.addEventListener('scroll', () => {
                const currentScroll = window.pageYOffset;
                
                if (currentScroll <= 0) {
                    bottomNav.classList.remove('hidden');
                } else {
                    if (currentScroll > lastScroll && currentScroll > 50) {
                        // Scrolling DOWN -> Hide
                        bottomNav.classList.add('hidden');
                    } else {
                        // Scrolling UP -> Show
                        bottomNav.classList.remove('hidden');
                    }
                }
                lastScroll = currentScroll;
            });
            
            if("serviceWorker" in navigator) {
                navigator.serviceWorker.register("./service-worker.js").catch(e => console.log("SW Error:", e));
            }
        });
    </script>
</body>
</html>
