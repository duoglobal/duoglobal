<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Add New Profile | DuoGlobal Admin</title>
    <meta name="theme-color" content="#0052CC">

    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/images/icon-192.png">
    <link rel="apple-touch-icon" href="assets/images/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root {
            --primary: #0052CC;
            --primary-dark: #003E99;
            --primary-gradient: linear-gradient(135deg, #0052CC 0%, #003380 100%);
            --bg-light: #f8fafc;
            --white: #ffffff;
            --text-dark: #1e293b;
            --text-grey: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #166534;
            
            --glass-bg: rgba(255, 255, 255, 0.95);
            --shadow-card: 0 10px 30px rgba(0,0,0,0.06);
            --shadow-float: 0 10px 30px rgba(0,82,204,0.3);
            --border-radius: 20px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {margin:0;padding:0;box-sizing:border-box;}

        body {
            font-family: 'Inter', sans-serif;
            background: url('assets/images/background.png') repeat, var(--bg-light);
            background-size: 400px;
            color: var(--text-dark);
            min-height: 100vh;
            padding: 30px;
            padding-bottom: 120px; /* Space for bottom nav */
            -webkit-font-smoothing: antialiased;
            opacity: 0;
            animation: fadeInPage 0.6s ease-out forwards;
        }

        @keyframes fadeInPage { to { opacity: 1; } }

        /* PRELOADER */
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .loader {
            width: 40px; height: 40px; border: 4px solid var(--border);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .header h1 { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); letter-spacing: -0.5px; }
        .header p { color: var(--text-grey); font-size: 0.95rem; margin-top: 5px; }
        
        .btn-back {
            text-decoration: none;
            color: var(--text-grey);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            padding: 8px 12px;
            border-radius: 8px;
            white-space: nowrap;
        }
        .btn-back:hover { color: var(--primary); background: rgba(0,82,204,0.05); }

        /* FORM CARD */
        .form-card {
            background: var(--glass-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(255,255,255,0.8);
            padding: 40px;
            max-width: 1000px; margin: 0 auto;
            backdrop-filter: blur(10px);
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.2s backwards;
        }

        .form-grid {
            display: grid; grid-template-columns: 280px 1fr; gap: 40px;
        }

        /* LEFT COLUMN: UPLOAD */
        .upload-section {
            display: flex; flex-direction: column;
        }
        .image-preview-box {
            width: 100%; aspect-ratio: 3/4; background: #f8fafc;
            border: 2px dashed #cbd5e1; border-radius: 16px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden; cursor: pointer; transition: var(--transition);
            position: relative; margin-bottom: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .image-preview-box:hover { 
            border-color: var(--primary); background: #eff6ff; 
            transform: translateY(-2px);
        }
        
        .preview-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .upload-placeholder { color: #94a3b8; padding: 20px; text-align: center; transition: var(--transition); }
        .upload-placeholder i { font-size: 2.5rem; margin-bottom: 15px; color: var(--primary); opacity: 0.6; }

        .file-hint { font-size: 0.8rem; color: var(--text-grey); text-align: center; line-height: 1.4; }

        /* RIGHT COLUMN: INPUTS */
        .form-section-title {
            font-size: 0.85rem; font-weight: 700; text-transform: uppercase; color: var(--text-grey);
            letter-spacing: 1px; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 25px; margin-top: 10px;
        }

        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        
        .form-label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); }
        
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 14px; border: 1px solid var(--border);
            border-radius: 12px; font-size: 0.95rem; font-family: inherit;
            transition: var(--transition); background: rgba(255,255,255,0.8);
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus { 
            outline: none; border-color: var(--primary); 
            box-shadow: 0 4px 15px rgba(0,82,204,0.1); 
            background: #fff; transform: translateY(-1px);
        }

        /* BUTTONS */
        .btn-submit {
            width: 100%; background: var(--primary-gradient); color: white; padding: 16px;
            border: none; border-radius: 12px; font-weight: 700; font-size: 1rem;
            cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-top: 30px; box-shadow: 0 10px 25px rgba(0,82,204,0.3);
        }
        .btn-submit:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(0,82,204,0.4); }
        .btn-submit:disabled { opacity: 0.7; cursor: not-allowed; transform: none; background: var(--text-grey); }

        /* SPINNER */
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; display: none; }
        
        /* BOTTOM NAV (Auto-Hide) */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 500px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 25px; border-radius: 30px; z-index: 9999;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.5);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .bottom-nav.hidden { transform: translateX(-50%) translateY(200%); }

        .nav-item { 
            text-decoration: none; color: #94a3b8; display: flex; flex-direction: column; 
            align-items: center; gap: 5px; font-size: 0.7rem; font-weight: 600; transition: 0.3s;
            flex: 1;
        }
        .nav-item i { font-size: 1.3rem; transition: 0.3s; }
        .nav-item:hover { color: var(--primary); }
        .nav-item:hover i { transform: translateY(-2px); }
        
        .nav-item-center {
            background: var(--primary-gradient); width: 54px; height: 54px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white; margin-top: -30px; 
            box-shadow: var(--shadow-float); border: 4px solid rgba(255,255,255,0.2);
            transform: scale(1.1); /* Highlighted since we are on this page */
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .nav-item-center:hover { transform: scale(1.2) translateY(-5px); }
        .nav-item-center i { font-size: 1.5rem; }

        /* Hide the floating button properly when nav hides */
        .bottom-nav.hidden .nav-item-center { transform: scale(0); }

        /* Animations */
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .form-grid { grid-template-columns: 1fr; gap: 30px; }
            .image-preview-box { max-width: 300px; margin: 0 auto 15px; }
            .header { align-items: flex-start; flex-direction: column; gap: 15px; }
            .btn-back { align-self: flex-start; }
        }
    </style>
</head>
<body>

    <!-- Preloader -->
    <div id="preloader">
        <div class="loader"></div>
    </div>

    <!-- Header -->
    <div class="header">
        <div>
            <h1>New Gentleman Profile</h1>
            <p>Create a profile to be listed on the dashboard.</p>
        </div>
        <a href="admin-dashboard.html" class="btn-back"><i class="fas fa-arrow-left"></i> Dashboard</a>
    </div>

    <!-- Form Card -->
    <div class="form-card">
        <form id="createProfileForm">
            <div class="form-grid">
                
                <!-- Left Column: Image -->
                <div class="upload-section">
                    <label class="form-label" style="text-align: center;">Profile Photo</label>
                    <div class="image-preview-box" id="dropZone">
                        <img id="previewImg" class="preview-img" alt="Preview">
                        <div class="upload-placeholder" id="uploadPlaceholder">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p style="font-weight: 600; font-size: 0.95rem; color:var(--text-dark);">Upload Photo</p>
                            <p style="font-size: 0.8rem;">or drag & drop</p>
                        </div>
                        <input type="file" id="fileInput" accept="image/*" style="display: none;" required>
                    </div>
                    <p class="file-hint">Required. Supported formats: JPG, PNG. Max size: 5MB. <br> Use a high-quality portrait.</p>
                </div>

                <!-- Right Column: Details -->
                <div class="details-section">
                    
                    <!-- Public Info -->
                    <div class="form-section-title">Public Information</div>
                    
                    <div class="form-group">
                        <label class="form-label">Occupation / Title</label>
                        <input type="text" id="occupation" class="form-input" placeholder="e.g. Senior Architect" required>
                    </div>

                    <div class="input-row">
                        <div>
                            <label class="form-label">Age</label>
                            <input type="number" id="age" class="form-input" placeholder="e.g. 34" min="18" max="80" required>
                        </div>
                        <div>
                            <label class="form-label">Height</label>
                            <input type="text" id="height" class="form-input" placeholder="e.g. 6'1 ft">
                        </div>
                    </div>

                    <div class="input-row">
                        <div>
                            <label class="form-label">Nationality</label>
                            <input type="text" id="nationality" class="form-input" placeholder="e.g. Canadian" required>
                        </div>
                        <div>
                            <label class="form-label">Flag Emoji</label>
                            <input type="text" id="flagEmoji" class="form-input" placeholder="üá®üá¶">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">City of Residence</label>
                        <input type="text" id="city" class="form-input" placeholder="e.g. Toronto" required>
                    </div>

                    <div class="input-row">
                        <div>
                            <label class="form-label">Education</label>
                            <select id="education" class="form-select">
                                <option value="Bachelors">Bachelors</option>
                                <option value="Masters">Masters</option>
                                <option value="PhD">PhD</option>
                                <option value="High School">High School</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Religion</label>
                            <input type="text" id="religion" class="form-input" placeholder="Optional">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">About (Bio)</label>
                        <textarea id="bio" class="form-textarea" rows="4" placeholder="Describe personality, hobbies, and values..." required></textarea>
                    </div>

                    <!-- Private Info -->
                    <div class="form-section-title" style="margin-top: 35px; color: var(--primary);">
                        <i class="fas fa-lock" style="font-size: 0.8rem; margin-right:5px;"></i> Private Contact Details
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-grey); margin-bottom: 20px; background:rgba(0,82,204,0.05); padding:10px; border-radius:8px; border:1px solid rgba(0,82,204,0.1);">
                        These details are hidden from public view until a user pays to unlock them.
                    </p>

                    <div class="input-row">
                        <div>
                            <label class="form-label">Phone (WhatsApp)</label>
                            <input type="tel" id="phone" class="form-input" placeholder="+1 234 567 890" required>
                        </div>
                        <div>
                            <label class="form-label">Email Address</label>
                            <input type="email" id="email" class="form-input" placeholder="email@example.com" required>
                        </div>
                    </div>

                    <!-- Submit -->
                    <button type="submit" class="btn-submit" id="submitBtn">
                        <span id="btnText">Publish Profile</span>
                        <div class="spinner" id="spinner"></div>
                    </button>

                </div>
            </div>
        </form>
    </div>

    <!-- Bottom Navigation (Auto-Hide) -->
    <nav class="bottom-nav" id="bottomNav">
        <a href="admin-dashboard.html" class="nav-item">
            <i class="fas fa-home"></i> <span>Home</span>
        </a>
        <a href="admin-users.html" class="nav-item">
            <i class="fas fa-users"></i> <span>Users</span>
        </a>
        <a href="admin-add-profile.html" class="nav-item-center">
            <i class="fas fa-plus"></i>
        </a>
        <a href="admin-settings.html" class="nav-item">
            <i class="fas fa-cog"></i> <span>Settings</span>
        </a>
    </nav>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { auth, db, storage } from './config.js'; 
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';
        import { collection, addDoc, serverTimestamp, doc, getDoc } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js';
        import { ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-storage.js';

        const preloader = document.getElementById('preloader');

        // Remove Preloader
        window.addEventListener('load', () => {
            preloader.style.opacity = '0';
            setTimeout(() => preloader.style.display = 'none', 500);
        });

        // Admin Check
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (!userDoc.exists() || userDoc.data().role !== 'admin') {
                        window.location.href = 'index.html';
                    }
                } catch (e) {
                    console.error("Auth check failed", e);
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        // Image Preview Logic
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const previewImg = document.getElementById('previewImg');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');

        dropZone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', handleFileSelect);

        // Drag & Drop support
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#0052CC'; dropZone.style.background = '#eff6ff'; });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.borderColor = '#cbd5e1'; dropZone.style.background = '#f8fafc'; });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#cbd5e1';
            dropZone.style.background = '#f8fafc';
            if(e.dataTransfer.files[0]) {
                fileInput.files = e.dataTransfer.files; // Assign to input
                handleFileSelect({ target: fileInput });
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    previewImg.style.display = 'block';
                    uploadPlaceholder.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        // Form Submission
        const form = document.getElementById('createProfileForm');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const spinner = document.getElementById('spinner');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Basic Validation
            if (!fileInput.files[0]) { alert("Please select a photo."); return; }

            setLoading(true);

            try {
                // 1. Upload Photo
                const file = fileInput.files[0];
                const storageRef = ref(storage, `men_profiles/${Date.now()}_${file.name}`);
                await uploadBytes(storageRef, file);
                const photoURL = await getDownloadURL(storageRef);

                // 2. Add to Firestore
                const profileData = {
                    occupation: document.getElementById('occupation').value,
                    age: parseInt(document.getElementById('age').value),
                    height: document.getElementById('height').value,
                    nationality: document.getElementById('nationality').value,
                    flagEmoji: document.getElementById('flagEmoji').value || 'üåç',
                    city: document.getElementById('city').value,
                    education: document.getElementById('education').value,
                    religion: document.getElementById('religion').value,
                    bio: document.getElementById('bio').value,
                    
                    // Private Data
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,

                    // System Data
                    photoURL: photoURL,
                    createdAt: serverTimestamp(),
                    status: 'active'
                };

                await addDoc(collection(db, "men_profiles"), profileData);

                alert("Profile Created Successfully!");
                window.location.href = "admin-dashboard.html";

            } catch (error) {
                console.error("Error creating profile:", error);
                alert("Failed to create profile: " + error.message);
                setLoading(false);
            }
        });

        function setLoading(isLoading) {
            if(isLoading) {
                submitBtn.disabled = true;
                btnText.style.display = 'none';
                spinner.style.display = 'block';
            } else {
                submitBtn.disabled = false;
                btnText.style.display = 'block';
                spinner.style.display = 'none';
            }
        }

    </script>

    <!-- Auto-Hide Bottom Nav Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bottomNav = document.getElementById('bottomNav');
            let lastScroll = 0;

            window.addEventListener('scroll', () => {
                const currentScroll = window.pageYOffset;
                
                if (currentScroll <= 0) {
                    bottomNav.classList.remove('hidden');
                } else {
                    if (currentScroll > lastScroll && currentScroll > 50) {
                        // Scrolling DOWN -> Hide
                        bottomNav.classList.add('hidden');
                    } else {
                        // Scrolling UP -> Show
                        bottomNav.classList.remove('hidden');
                    }
                }
                lastScroll = currentScroll;
            });
            
            if("serviceWorker" in navigator) {
                navigator.serviceWorker.register("./service-worker.js").catch(e => console.log("SW Error:", e));
            }
        });
    </script>
</body>
</html>
